<!-- ============================================================
  قسم إدارة الفروع - أضفه داخل index.html في قسم الإدارة
  ============================================================ -->

<!-- زر الفروع في الـ Sidebar (أضفه جوا nav-manage) -->
<!--
<li>
  <a class="submenu-link sidebar-link" href="javascript:void(0)" onclick="showView('branches')">
    <i class="fa fa-building me-2"></i> الفروع
  </a>
</li>
-->

<!-- قسم الفروع الرئيسي (أضفه مع باقي .view-section) -->
<section id="view-branches" class="view-section" style="display:none;">
  <div class="container-fluid px-3 py-3" style="direction: rtl;">

    <!-- هيدر القسم -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h4 class="fw-bold m-0">
          <i class="fa fa-building text-primary me-2"></i>إدارة الفروع
        </h4>
        <small class="text-muted">إضافة وتعديل وحذف الفروع وتعيين المستخدمين</small>
      </div>
      <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="openAddBranchModal()">
        <i class="fa fa-plus me-1"></i> فرع جديد
      </button>
    </div>

    <!-- قائمة الفروع -->
    <div class="card border-0 shadow-sm rounded-4 mb-4">
      <div class="card-body p-3">
        <h6 class="fw-bold mb-3">
          <i class="fa fa-list text-primary me-1"></i> الفروع المسجلة
        </h6>
        <div id="branchesList">
          <div class="text-center p-3 text-muted small">جاري التحميل...</div>
        </div>
      </div>
    </div>

    <!-- تعيين فرع للمستخدم -->
    <div class="card border-0 shadow-sm rounded-4 mb-4 admin-only-section">
      <div class="card-body p-3">
        <h6 class="fw-bold mb-3">
          <i class="fa fa-user-tag text-warning me-1"></i> تعيين فرع لمستخدم
        </h6>
        <div class="row g-2">
          <div class="col-12 col-md-5">
            <label class="form-label small fw-bold">اختر المستخدم</label>
            <select id="assignUserSelect" class="form-select form-select-sm">
              <option value="">-- اختر مستخدم --</option>
            </select>
          </div>
          <div class="col-12 col-md-5">
            <label class="form-label small fw-bold">اختر الفرع</label>
            <select id="assignBranchSelect" class="form-select form-select-sm">
              <option value="">-- اختر فرع --</option>
            </select>
          </div>
          <div class="col-12 col-md-2 d-flex align-items-end">
            <button class="btn btn-success btn-sm w-100" onclick="handleAssignUserToBranch()">
              <i class="fa fa-check me-1"></i> تعيين
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ملخص إحصائيات الفروع (للمدير العام) -->
    <div class="card border-0 shadow-sm rounded-4 admin-only-section">
      <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="fw-bold m-0">
            <i class="fa fa-chart-bar text-info me-1"></i> ملخص الفروع
          </h6>
          <button class="btn btn-sm btn-light border" onclick="renderBranchesSummary()">
            <i class="fa fa-rotate-right me-1"></i> تحديث
          </button>
        </div>
        <div id="branches-summary-container">
          <div class="text-center p-3 text-muted small">اضغط تحديث لعرض الإحصائيات</div>
        </div>
      </div>
    </div>

  </div>
</section>


<!-- ============================================================
  شارة الفرع الحالي - أضفها في الهيدر العلوي بجانب اسم المستخدم
  ============================================================ -->
<!--
<div id="current-branch-badge" class="me-2"></div>
-->


<script>
// ========== تحميل البيانات عند فتح قسم الفروع ==========

// أضف الحالة دي في دالة showView() الموجودة في app.js:
// } else if (viewName === 'branches') {
//     loadBranchesTable();
//     populateBranchSelect('assignBranchSelect');
//     loadUsersForAssign();
// }

/**
 * تحميل قائمة المستخدمين لقائمة التعيين
 */
async function loadUsersForAssign() {
    const select = document.getElementById('assignUserSelect');
    if (!select) return;

    const { data: users } = await window.supa
        .from('users')
        .select('id, name, email, branch_id, branches(name)')
        .order('name');

    select.innerHTML = '<option value="">-- اختر مستخدم --</option>';
    
    (users || []).forEach(user => {
        const currentBranch = user.branches?.name ? ` (${user.branches.name})` : ' (بدون فرع)';
        select.innerHTML += `<option value="${user.id}">${user.name || user.email}${currentBranch}</option>`;
    });
}

/**
 * تنفيذ تعيين المستخدم للفرع
 */
async function handleAssignUserToBranch() {
    const userId = document.getElementById('assignUserSelect').value;
    const branchId = document.getElementById('assignBranchSelect').value;

    if (!userId || !branchId) {
        showToast('يرجى اختيار المستخدم والفرع', false);
        return;
    }

    const success = await assignUserToBranch(userId, branchId);
    if (success) {
        loadUsersForAssign(); // تحديث القائمة
        if (typeof loadUsersTable === 'function') loadUsersTable(); // تحديث جدول الأعضاء إن وجد
    }
}
</script>
