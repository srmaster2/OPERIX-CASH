async function getCurrentUser(){let{data:{user:e}}=await supabase.auth.getUser();if(!e)return{role:"GUEST",email:"",isMaster:!1};let{data:a,error:t}=await supabase.from(TABLES.users).select("*, branches(name, location)").eq("email",e.email).maybeSingle();return!t&&a?{role:a.role||"USER",email:e.email,name:a.name||e.email,isMaster:a.is_master||!1,branch_id:a.branch_id||null,branchName:a.branches?.name||"الرئيسي"}:(await supabase.from(TABLES.users).insert({email:e.email,name:e.user_metadata?.name||e.email,role:"USER",is_master:!1}),{role:"USER",email:e.email,name:e.user_metadata?.name||e.email,isMaster:!1})}async function getAllUsers(){let{data:e,error:a}=await supabase.from("users").select("*");return a?(showToast("خطأ في جلب قائمة المستخدمين: "+a.message,!1),[]):e}async function renderUsersList(){let e=await getAllUsers(),a=document.getElementById("users-table-body");if(0===e.length){a.innerHTML='<tr><td colspan="3">لا يوجد مستخدمين حالياً</td></tr>';return}a.innerHTML=e.map(e=>`
    <tr>
      <td>${e.name}</td>
      <td>${e.email}</td>
      <td>${e.role}</td>
    </tr>
  `).join("")}async function signIn(e,a){let{data:t,error:n}=await supabase.auth.signInWithPassword({email:e,password:a});return n?(showToast("خطأ في تسجيل الدخول: "+n.message,!1),!1):(showToast("تم تسجيل الدخول بنجاح"),window.location.href="index.html",!0)}async function signUp(e,a,t){let{data:n,error:s}=await supabase.auth.signUp({email:e,password:a,options:{data:{name:t}}});return s?(showToast("خطأ في إنشاء الحساب: "+s.message,!1),!1):(showToast("تم إنشاء الحساب، تحقق من بريدك الإلكتروني"),!0)}async function signOut(){let{error:e}=await supabase.auth.signOut();e?showToast("خطأ في تسجيل الخروج",!1):(showToast("تم تسجيل الخروج"),window.location.href="login.html")}async function hasPermission(e,a){return!!e.isMaster||"staff"===a&&"admin"===e.role||e.role===a}async function getUserByEmail(e){let{data:a,error:t}=await supabase.from("users").select("*").eq("email",e).single();return t||!a?null:a}function onSettingsOpen(){window.supa.auth.getUser().then(({data:{user:e}})=>{e&&(document.getElementById("profileNameInput").value=e.user_metadata?.name||"")})}async function handleUpdateName(){let e=document.getElementById("profileNameInput").value;if(!e)return showToast("يرجى إدخال اسم",!1);let{error:a}=await window.supa.auth.updateUser({data:{name:e}});if(a)showToast("خطأ: "+a.message,!1);else{let{data:{user:t}}=await window.supa.auth.getUser();await window.supa.from("users").update({name:e}).eq("email",t.email),showToast("تم تحديث الاسم بنجاح")}}async function handleUpdatePassword(){let e=document.getElementById("newPass").value,a=document.getElementById("confirmPass").value;if(e.length<6)return showToast("يجب أن تكون 6 رموز على الأقل",!1);if(e!==a)return showToast("كلمات المرور غير متطابقة",!1);let{error:t}=await window.supa.auth.updateUser({password:e});t?showToast("حدث خطأ: "+t.message,!1):(showToast("تم تغيير كلمة المرور بنجاح"),togglePasswordFields(),document.getElementById("newPass").value="",document.getElementById("confirmPass").value="")}function togglePasswordFields(){let e=document.getElementById("passwordFields");e.style.display="none"===e.style.display?"block":"none"}async function loadAccountData(){try{let{data:{user:e},error:a}=await window.supa.auth.getUser();if(a||!e)return;let{data:t}=await window.supa.from("users").select("*").eq("email",e.email).maybeSingle();document.getElementById("profileEmailInput")&&(document.getElementById("profileEmailInput").value=e.email);let n=document.getElementById("profileNameInput");n&&(n.value=t?.name||e.user_metadata?.name||e.email.split("@")[0])}catch(s){console.error("Error loading profile:",s)}}async function handleUpdateName(){let e=document.getElementById("profileNameInput").value;if(!e)return showToast("يرجى إدخال اسم",!1);let{error:a}=await window.supa.auth.updateUser({data:{name:e}}),{data:{user:t}}=await window.supa.auth.getUser(),{error:n}=await window.supa.from("users").update({name:e}).eq("email",t.email);if(a||n)showToast("فشل تحديث الاسم",!1);else{showToast("تم تحديث الاسم بنجاح");let s=document.querySelector(".user-name");s&&(s.innerText=e)}}async function handleUpdatePassword(){let e=document.getElementById("newPass").value,a=document.getElementById("confirmPass").value;if(e.length<6){showToast("كلمة المرور يجب أن تكون 6 أحرف على الأقل",!1);return}if(e!==a){showToast("كلمات المرور غير متطابقة",!1);return}let{error:t}=await window.supa.auth.updateUser({password:e});t?showToast("خطأ: "+t.message,!1):(showToast("تم تغيير كلمة المرور بنجاح"),togglePasswordFields(),document.getElementById("newPass").value="",document.getElementById("confirmPass").value="")}function togglePasswordFields(){let e=document.getElementById("passwordFields");e.style.display="none"===e.style.display?"block":"none"}async function loadAccountData(){try{let{data:{user:e},error:a}=await window.supa.auth.getUser();if(a||!e)return;let{data:t,error:n}=await window.supa.from("users").select("*").eq("email",e.email).maybeSingle();document.getElementById("displayProfileEmail").innerText=e.email,document.getElementById("displayProfileName").innerText=t?.name||e.user_metadata?.name||"غير محدد";let s=t?.role==="admin"?"مدير نظام":t?.is_master?"المدير العام":"موظف";document.getElementById("displayProfileRole").innerText=s}catch(l){console.error("Error loading account data:",l)}}async function handleUpdatePassword(){let e=document.getElementById("newPass").value,a=document.getElementById("confirmPass").value;if(!e||e.length<6){showToast("يجب أن تكون كلمة المرور 6 أحرف على الأقل",!1);return}if(e!==a){showToast("كلمات المرور غير متطابقة",!1);return}let{error:t}=await window.supa.auth.updateUser({password:e});t?showToast("خطأ: "+t.message,!1):(showToast("✅ تم تحديث كلمة المرور بنجاح"),document.getElementById("newPass").value="",document.getElementById("confirmPass").value="")}async function showSection(e){document.querySelectorAll(".view-section").forEach(e=>{e.style.display="none"});let a=document.getElementById(e);a&&(a.style.display="block"),"view-settings"===e&&loadAccountData()}function toggleTheme(){let e=document.body,a=document.getElementById("themeIcon");e.classList.toggle("light-mode"),e.classList.contains("light-mode")?(a.classList.replace("fa-moon","fa-sun"),localStorage.setItem("theme","light")):(a.classList.replace("fa-sun","fa-moon"),localStorage.setItem("theme","dark"))}document.addEventListener("DOMContentLoaded",()=>{let e=localStorage.getItem("theme");"light"===e&&(document.body.classList.add("light-mode"),document.getElementById("themeIcon").classList.replace("fa-moon","fa-sun"))});
