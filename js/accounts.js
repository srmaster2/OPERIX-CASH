async function loadAccounts(){let e=window.currentUserData,t=supabase.from("accounts").select("*");e&&"function"==typeof applyBranchFilter&&(t=applyBranchFilter(t,e));let{data:l,error:a}=await t;return a?[]:l.filter(e=>!e.deleted)}async function addAccount(e,t,l="",a=0){if(!e)return!1;let{error:n}=await supabase.from("accounts").insert([{name:e,type:t,tag:l,balance:Number(a)}]);return!n}async function updateAccount(e,t){let l=await updateSupabase(TABLES.accounts,t,e);return l.success?(showToast("تم التحديث"),!0):(showToast("خطأ في التحديث",!1),!1)}async function deleteAccount(e){let t=await updateSupabase(TABLES.accounts,{deleted:!0},e);return t.success?(showToast("تم الحذف"),loadAccountsList(),!0):(showToast("خطأ في الحذف",!1),!1)}async function loadAccountsTable(){let e=document.getElementById("accList");if(e)try{let t=window.currentUserData,l=supabase.from("accounts").select("*");t&&"function"==typeof applyBranchFilter&&(l=applyBranchFilter(l,t));let{data:a,error:n}=await l.order("is_pinned",{ascending:!1}).order("name",{ascending:!0});if(n)throw n;let i="";a.forEach(e=>{let t=!0===e.is_pinned,l=e.color||"#dee2e6",a="شركة"===e.tag?"#10b981":"#0ea5e9";i+=`
            <div class="acc-row d-flex align-items-center p-2 mb-2 bg-white border rounded-3 shadow-sm" style="border-right: 5px solid ${a} !important; direction: rtl;">
                
                <div style="width: 40%;" class="text-start ps-2">
                    <div class="fw-bold text-dark text-truncate" style="font-size: 13px;">
                        <i class="fa-solid fa-circle me-1" style="color: ${l}; font-size: 8px;"></i>
                        ${e.name}
                    </div>
                    ${e.tag?`<span class="badge" style="background-color:${a}20; color:${a}; font-size:9px; border: 1px solid ${a}40;">${e.tag}</span>`:""}
                </div>

                <div style="width: 30%;" class="text-center border-start border-end">
                    <div class="english-num fw-bold text-dark" style="font-size: 14px;">
                        ${Number(e.balance||0).toLocaleString()}
                    </div>
                </div>

                        <button class="btn btn-sm btn-light border p-1" onclick="handleTogglePin(${e.id})" title="تثبيت">
                            <i id="pin-icon-${e.id}" class="fa-solid fa-thumbtack ${t?"text-warning":"text-muted opacity-50"}"></i>
                        </button>   
                    <button class="btn btn-sm btn-light border text-warning p-1" onclick="openTagModal(${e.id}, '${e.tag||""}', '${e.color||""}')">
                        <i class="fa-solid fa-paintbrush"></i>
                    </button>
                    <button class="btn btn-sm btn-light border text-primary p-1" onclick="openEditAccountModal(${e.id})">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-light border text-danger p-1" onclick="confirmDeleteAccount(${e.id}, '${e.name}')">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            </div>`}),e.innerHTML=i||'<div class="text-center p-4 small text-muted">لا يوجد حسابات</div>'}catch(o){console.error("Load Error:",o),e.innerHTML='<div class="alert alert-danger p-2 small">خطأ في تحميل الحسابات</div>'}}async function confirmDeleteAccount(e,t){let{isConfirmed:l}=await Swal.fire({title:"حذف الحساب؟",text:`هل أنت متأكد من حذف "${t}"؟`,icon:"warning",showCancelButton:!0,confirmButtonText:"نعم، احذف",cancelButtonText:"إلغاء"});if(l){let a=parseInt(e);if(isNaN(a)){showToast("❌ خطأ: معرف الحساب غير صالح",!1);return}let{error:n}=await supabase.from("accounts").delete().eq("id",a);n?showToast("❌ خطأ في الحذف: "+n.message,!1):(showToast("✅ تم الحذف بنجاح",!0),loadAccountsTable())}}async function openTagModal(e,t,l){let{value:a}=await Swal.fire({title:"إعدادات الوسم واللون",html:`<input id="swal-tag" class="swal2-input" placeholder="الوسم (مثلاً: فودافون)" value="${t}"><p class="mb-1 mt-2 small">اختر لون الحساب:</p><input id="swal-color" type="color" class="form-control form-control-color w-100" value="${l||"#0ea5e9"}">`,showCancelButton:!0,confirmButtonText:"حفظ",cancelButtonText:"إلغاء",preConfirm:()=>({tag:document.getElementById("swal-tag").value.trim(),color:document.getElementById("swal-color").value})});if(a){showToast("جاري التحديث...",!0);try{let{error:n}=await supabase.from("accounts").update({tag:a.tag,color:a.color}).eq("id",e);if(n)throw n;showToast("✅ تم حفظ التغييرات"),await loadAccountsTable(),"function"==typeof renderPinnedWallets&&await renderPinnedWallets()}catch(i){console.error("Update Error:",i),showToast("❌ فشل التحديث: "+i.message,!1)}}}async function openEditAccountModal(e){let{data:t}=await supabase.from("accounts").select("*").eq("id",e).single();if(!t)return;let{value:l}=await Swal.fire({title:'<span style="font-size:18px;">تعديل بيانات الحساب</span>',html:`
            <div style="direction: rtl; text-align: right;">
                <div class="mb-3">
                    <label class="swal2-input">اسم الحساب / الرقم</label>
                    <input id="edit-n" class="form-control form-control-sm" value="${t.name}">
                </div>
                <div class="mb-3">
                    <label class="swal2-input">الرصيد الحالي (ج.م)</label>
                    <input id="edit-b" type="number" class="form-control form-control-sm english-num" value="${t.balance}">
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <label class="swal2-input">حد السحب اليومي</label>
                        <input id="edit-lo" type="number" class="form-control form-control-sm" value="${t.daily_out_limit||0}">
                    </div>
                    <div class="col-6">
                        <label class="swal2-input">حد الإيداع اليومي</label>
                        <input id="edit-li" type="number" class="form-control form-control-sm" value="${t.daily_in_limit||0}">
                    </div>
                </div>
            </div>
        `,showCancelButton:!0,confirmButtonText:"حفظ التغييرات",cancelButtonText:"إلغاء",customClass:{confirmButton:"btn btn-primary btn-sm px-4",cancelButton:"btn btn-light btn-sm px-4"},buttonsStyling:!1,preConfirm:()=>({name:document.getElementById("edit-n").value,balance:document.getElementById("edit-b").value,daily_out_limit:document.getElementById("edit-lo").value,daily_in_limit:document.getElementById("edit-li").value})});if(l){let{error:a}=await supabase.from("accounts").update(l).eq("id",e);a||(showToast("✅ تم التحديث بنجاح"),loadAccountsTable())}}let currentFilterType="all";function setFilterType(e,t){currentFilterType=e;let l=document.querySelectorAll("#filterBtnGroup .btn");l.forEach(e=>{e.classList.remove("active","btn-secondary","btn-warning","btn-info","btn-success","btn-danger"),e.classList.add("btn-outline-secondary")}),t.classList.remove("btn-outline-secondary"),"all"===e?t.classList.add("active","btn-secondary"):"pinned"===e?t.classList.add("active","btn-warning"):"company"===e?t.classList.add("active","btn-success"):"wallet"===e?t.classList.add("active","btn-danger"):"tagged"===e&&t.classList.add("active","btn-info"),filterAccounts()}function filterAccounts(){let e=document.getElementById("accSearchInput").value.toLowerCase().trim(),t=document.querySelectorAll(".acc-row, .acc-card-pro, .client-card"),l=0;t.forEach(t=>{let a=t.textContent.toLowerCase(),n=a.includes(e),i=t.querySelector(".badge")?.textContent||"",o=t.querySelector(".fa-thumbtack")?.classList.contains("text-warning"),c=i.includes("شركة"),s=i.includes("محفظة")||i.includes("فودافون")||i.includes("كاش"),d=!1;"all"===currentFilterType?d=!0:"pinned"===currentFilterType?d=o:"company"===currentFilterType?d=c:"wallet"===currentFilterType?d=s:"tagged"===currentFilterType&&(d=""!==i),n&&d?(t.classList.remove("d-none"),t.classList.add("d-flex"),l++):(t.classList.remove("d-flex"),t.classList.add("d-none"))});let a=document.getElementById("countBadge");a&&(a.innerText=`${l} حساب`)}async function handleChangeTag(e,t){let{value:l}=await Swal.fire({title:"اختر الوسم",input:"select",inputOptions:{محفظة:"محفظة",شركة:"شركة",بنك:"بنك"},inputValue:t,showCancelButton:!0,confirmButtonText:"حفظ"});l&&(await supabase.from("accounts").update({tag:l}).eq("id",e),loadAccountsTable())}function editAccountUI(e){Swal.fire({title:"تعديل بيانات الحساب",text:"جاري فتح نافذة التعديل للحساب رقم "+e,icon:"info",timer:1e3,showConfirmButton:!1})}async function handleTogglePin(e){let t=document.getElementById(`pin-icon-${e}`),l=!!t&&t.classList.contains("text-warning"),a=!l;showToast("جاري التحديث...",!0);try{let{error:n}=await supabase.from("accounts").update({is_pinned:a}).eq("id",e);if(n)throw n;showToast(a?"\uD83D\uDCCC تم التثبيت":"\uD83D\uDD13 تم إلغاء التثبيت"),await loadAccountsTable(),"function"==typeof renderPinnedWallets&&renderPinnedWallets()}catch(i){showToast("❌ فشل: "+i.message,!1)}}async function delAcc(e){if(confirm("هل أنت متأكد من حذف هذا الحساب نهائياً؟"))try{let{error:t}=await supabase.from("accounts").delete().eq("id",e);if(t)throw t;showToast("تم الحذف بنجاح"),loadAccountsTable()}catch(l){showToast("فشل الحذف",!1)}}function openEdit(e,t,l,a,n){document.getElementById("editRow").value=e,document.getElementById("editName").value=t,document.getElementById("editLo").value=l,document.getElementById("editLi").value=a,document.getElementById("editLm").value=n,document.getElementById("editModal").style.display="flex"}async function saveEdit(){let e=document.getElementById("editRow").value,t=document.getElementById("editName").value,l=document.getElementById("editProfitAdj").value.replace(/,/g,""),a=Number(l);setLoading("btnSaveEdit",!0);try{let{error:n}=await supabase.from("accounts").update({name:t,daily_out_limit:document.getElementById("editLo").value,daily_in_limit:document.getElementById("editLi").value,monthly_limit:document.getElementById("editLm").value}).eq("id",e);if(n)throw n;if(0!==a&&!isNaN(a)){let{data:i}=await supabase.from("accounts").select("profit").eq("id",e).single(),o=(Number(i.profit)||0)+a;await supabase.from("accounts").update({profit:o}).eq("id",e)}setLoading("btnSaveEdit",!1),document.getElementById("editModal").style.display="none",showToast("✅ تم تحديث بيانات الحساب بنجاح",!0),loadAccountsTable(),document.getElementById("editProfitAdj").value=""}catch(c){console.error(c),showToast("خطأ أثناء الحفظ",!1),setLoading("btnSaveEdit",!1)}}async function addWallet(){let e=document.getElementById("newAccName").value.trim(),t=document.getElementById("newAccType").value;if(!e)return;setLoading("btnAddWallet",!0);let l="محفظة"===t?"60000":"900000000";try{let a=window.currentUserData,{error:n}=await supabase.from("accounts").insert([{name:e,tag:"محفظة"===t?"محفظة":"شركة",color:"محفظة"===t?"#007bff":"#ffc107",balance:"0",daily_out_limit:l,daily_in_limit:l,monthly_limit:"محفظة"===t?"200000":"900000000",is_pinned:!1,branch_id:a?.branch_id||null}]);if(n)throw n;showToast("✅ تمت الإضافة بنجاح",!0),document.getElementById("newAccName").value="",await loadAccountsTable()}catch(i){console.error("Supabase Insert Error:",i.message),showToast("❌ فشل الإضافة: "+i.message,!1)}finally{setLoading("btnAddWallet",!1)}}async function checkUserRole(){let{data:{user:e}}=await supabase.auth.getUser();if(!e){window.location.href="login.html";return}let{data:t}=await supabase.from("users").select("role").eq("email",e.email).single();t&&(window.currentUserRole=t.role,document.querySelectorAll(".admin-only").forEach(e=>{e.style.display="ADMIN"===t.role?"block":"none"}))}async function saveTagSettings(){let e=document.getElementById("tagRow").value,t=document.getElementById("tagInput").value.trim(),l=document.getElementById("tagColorInput").value;if(e){setLoading("btnSaveTag",!0);try{let{error:a}=await supabase.from("accounts").update({tag:t,color:l}).eq("id",e);if(a)throw a;showToast("✅ تم حفظ مظهر المحفظة بنجاح",!0),document.getElementById("tagModal").style.display="none","function"==typeof renderWalletsCards&&renderWalletsCards(),loadAccountsTable(),"function"==typeof renderPinnedWallets&&renderPinnedWallets()}catch(n){console.error("Update Error:",n.message),showToast("❌ فشل التحديث: "+n.message,!1)}finally{setLoading("btnSaveTag",!1)}}}async function resetTagSettings(){if(!confirm("⚠️ هل تريد مسح التخصيص (اللون والوسم) لهذه المحفظة؟"))return;let e=document.getElementById("tagRow").value;if(e){setLoading("btnSaveTag",!0);try{let{error:t}=await supabase.from("accounts").update({tag:"",color:"#6c757d"}).eq("id",e);if(t)throw t;document.getElementById("tagModal").style.display="none",showToast("✅ تم إعادة ضبط مظهر المحفظة",!0),refreshAllWalletViews()}catch(l){console.error("Reset Error:",l.message),showToast("❌ فشل إعادة الضبط",!1)}finally{setLoading("btnSaveTag",!1)}}}function refreshAllWalletViews(){"function"==typeof renderWalletsCards&&renderWalletsCards(),loadAccountsTable(),"function"==typeof renderPinnedWallets&&renderPinnedWallets()}function closeEdit(){document.getElementById("editModal").style.display="none",document.getElementById("editProfitAdj").value=""}function openEditCl(e,t,l,a){document.getElementById("editClRow").value=e,document.getElementById("editClName").value=t,document.getElementById("editClPhone").value=l,document.getElementById("editClBal").value=a,document.getElementById("editClientModal").style.display="flex"}function closeEditCl(){document.getElementById("editClientModal").style.display="none"}async function saveEditClient(){let e=document.getElementById("editClRow").value,t=document.getElementById("editClName").value.trim(),l=document.getElementById("editClPhone").value.trim(),a=Math.round(parseFloat(document.getElementById("editClBal").value))||0;if(!e){showToast("❌ خطأ: لم يتم تحديد معرف العميل",!1);return}setLoading("btnSaveCl",!0);try{let{error:n,count:i}=await window.supa.from("clients").update({name:t,number:l,balance:a}).eq("id",parseInt(e)).select();if(n)throw n;showToast("✅ تم تحديث بيانات العميل",!0),closeEditCl(),"function"==typeof loadClientsTable&&loadClientsTable()}catch(o){console.error(o),showToast("❌ خطأ: "+o.message,!1)}finally{setLoading("btnSaveCl",!1)}}function openEditRole(e,t){document.getElementById("editRoleEmail").value=e,document.getElementById("editRoleName").value=t,document.getElementById("currentUserName").innerText=t,document.getElementById("editRoleModal").style.display="flex"}function closeEditRole(){document.getElementById("editRoleModal").style.display="none"}async function saveUserRole(){let{data:{user:e}}=await supabase.auth.getUser();if(!e){showToast("❌ يجب تسجيل الدخول أولاً",!1);return}try{setLoading("btnSaveRole",!0);let{data:t,error:l}=await supabase.from("users").select("is_master").eq("id",e.id).single();if(l||!t||!t.is_master){showToast("\uD83D\uDEAB ليس لديك صلاحية Master لتعديل الأدوار",!1),setLoading("btnSaveRole",!1);return}let a=document.getElementById("editRoleEmail").value,n=document.getElementById("newRoleSelect").value,{error:i}=await supabase.from("users").update({role:n}).eq("email",a);if(i)throw i;showToast("✅ تم تحديث الصلاحية بنجاح",!0),closeEditRole(),e.email===a?(showToast("\uD83D\uDD04 جاري تحديث صلاحياتك...",!0),setTimeout(()=>{window.location.reload()},1e3)):"function"==typeof loadUsersList&&await loadUsersList()}catch(o){showToast("❌ خطأ: "+o.message,!1)}finally{setLoading("btnSaveRole",!1)}}function showNotifications(){document.getElementById("notificationModal").style.display="flex"}function closeNotificationModal(){document.getElementById("notificationModal").style.display="none"}function closeConfirmModal(){document.getElementById("confirmOpModal").style.display="none"}function closeLogModal(){document.getElementById("logDetailsModal").style.display="none"}function closeLogModalOutside(e){e.target===document.getElementById("logDetailsModal")&&closeLogModal()}function showSecurePass(e){window._secureCallback=e,document.getElementById("securePassModal").style.display="flex",setTimeout(()=>document.getElementById("secureInput")?.focus(),100)}function verifySecurePass(){let e=document.getElementById("secureInput").value;"1234"===e?(document.getElementById("securePassModal").style.display="none",document.getElementById("secureInput").value="","function"==typeof window._secureCallback&&window._secureCallback()):(showToast("❌ كلمة المرور خاطئة",!1),document.getElementById("secureInput").value="")}
