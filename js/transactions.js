let dynamicLockList=[];var globalPendingData=null,selectedProvider="",isRenderingPins=!1;const _supa=()=>window.supa;function setupLiveLogs(){let e=_supa();e.channel("public:transactions").on("postgres_changes",{event:"INSERT",schema:"public",table:"transactions"},()=>{executeAdvancedSearch()}).on("postgres_changes",{event:"DELETE",schema:"public",table:"transactions"},()=>{executeAdvancedSearch()}).subscribe()}async function getSession(){let{data:e}=await _supa().auth.getSession();return e.session}function setOp(e,t,a){let n=document.getElementById("wallet"),i=document.getElementById("type");i&&(i.value=e),selectedProvider=t||"",document.querySelectorAll(".op-card").forEach(e=>e.classList.remove("active","active-op")),a&&a.classList.add("active","active-op");let l=_norm(t),o=e.includes("Ø³Ø­Ø¨ ÙƒØ§Ø´")&&e.includes("ØªØ²ÙˆÙŠØ¯"),s=!o&&dynamicLockList.some(e=>_norm(e)===l)&&(e.includes("Ø³Ø­Ø¨")||e.includes("ÙØ§ØªÙˆØ±Ø©"));if(s&&n){let r=!1;for(let d=0;d<n.options.length;d++)if(_norm(n.options[d].text).includes(l)){n.selectedIndex=d,r=!0;break}r&&(n.disabled=!0,n.style.backgroundColor="var(--bg-body)",n.style.cursor="not-allowed")}else n&&(n.disabled=!1,n.style.backgroundColor="",n.style.cursor="default",dynamicLockList.some(e=>_norm(e)===l)||(n.selectedIndex=0));_toggleOpFields(e),"function"==typeof updateLimitDisplay&&updateLimitDisplay(),n?.dispatchEvent(new Event("change")),setTimeout(()=>{let e=document.getElementById("amount");e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus())},400)}function _norm(e){return e?String(e).replace(/[Ø£Ø¥Ø¢Ø§]/g,"Ø§").replace(/\s+/g,"").trim().toLowerCase():""}function _toggleOpFields(e){let t=/Ø¯ÙŠÙ†|Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©|Ø³Ø¯Ø§Ø¯/.test(e||""),a=e&&!t&&!e.includes("Ù…ØµØ±ÙˆÙ"),n=(e,t)=>{let a=document.getElementById(e);a&&(a.style.display=t?"block":"none")};n("clientFieldContainer",t),n("commDestinationContainer",a),n("deductCommContainer",a),t&&"function"==typeof loadClientsToSelect&&loadClientsToSelect()}document.addEventListener("DOMContentLoaded",()=>{setupLiveLogs(),executeAdvancedSearch()});const serviceMap={client_withdraw:{label:"Ø³Ø­Ø¨ Ù…Ù† Ø¹Ù…ÙŠÙ„",buildTitle:e=>`Ø³Ø­Ø¨ Ù…Ù† Ø¹Ù…ÙŠÙ„ (ØªØ²ÙˆÙŠØ¯ ${e})`,filterTag:"Ø´Ø±ÙƒØ©",needsWallet:!1},pay_bill:{label:"Ø¯ÙØ¹ ÙØ§ØªÙˆØ±Ø©",buildTitle:e=>`Ø¯ÙØ¹ ÙØ§ØªÙˆØ±Ø© (${e})`,filterTag:"Ø´Ø±ÙƒØ©",needsWallet:!1},cash_supply:{label:"Ø³Ø­Ø¨ ÙƒØ§Ø´",buildTitle:e=>`Ø³Ø­Ø¨ ÙƒØ§Ø´ (ØªØ²ÙˆÙŠØ¯ ${e})`,filterTag:"Ø´Ø±ÙƒØ©",needsWallet:!0},visa_withdraw:{label:"Ø³Ø­Ø¨ ÙÙŠØ²Ø§",buildTitle:e=>`Ø³Ø­Ø¨ ÙÙŠØ²Ø§ (Ù…Ø§ÙƒÙŠÙ†Ø© ${e})`,filterTag:"Ø´Ø±ÙƒØ©",needsWallet:!1}};function getProviderGradient(e){let t={ÙÙˆØ±ÙŠ:["#ff6b00","#ff8f00"],Ø£Ù…Ø§Ù†:["#21bce2","#0ea5e9"],Ù…ÙƒØ³Ø¨:["#153d96","#1e40af"],Ø¶Ø§Ù…Ù†:["#7c3aed","#5b21b6"],Ø¨Ø³Ø§Ø·Ø©:["#dc2626","#ef4444"],Ù…Ø´ØªØ±ÙŠØ§Øª:["#059669","#10b981"],2090:["#1e293b","#475569"]};if(t[e])return`linear-gradient(135deg, ${t[e][0]}, ${t[e][1]})`;let a=0;for(let n=0;n<e.length;n++)a=e.charCodeAt(n)+((a<<5)-a);let i=Math.abs(a)%360;return`linear-gradient(135deg, hsl(${i}, 75%, 40%), hsl(${i}, 75%, 30%))`}async function openProviderSelect(e,t){document.querySelectorAll(".op-card").forEach(e=>e.classList.remove("active","active-op")),t&&t.classList.add("active","active-op");let a=serviceMap[e];if(!a)return;document.getElementById("selectedServiceKey").value=e;let n=document.getElementById("providerButtonsGrid"),i=document.getElementById("providerModal");if(n&&i){n.innerHTML='<div class="text-center p-4"><i class="fa fa-circle-notch fa-spin fa-3x text-primary"></i></div>',i.style.display="flex";try{let l=window.currentUserData,o=_supa().from("accounts").select("id, name, balance").gt("daily_out_limit",9e6).not("name","ilike","%Ø®Ø²Ù†Ø©%").not("name","ilike","%ÙƒØ§Ø´%");"function"==typeof applyBranchFilter&&(o=applyBranchFilter(o,l)),o=o.order("name");let{data:s,error:r}=await o;if(r)throw r;if(dynamicLockList=s?s.map(e=>e.name):[],n.innerHTML="",0===dynamicLockList.length){n.innerHTML='<div class="p-4 text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';return}s.forEach(t=>{let a=document.createElement("button");a.type="button",a.className="provider-card";let i=getProviderGradient(t.name),l=Number(t.balance||0).toLocaleString();a.style.background=i,a.innerHTML=`
                <div class="provider-info">
                    <span class="provider-name">${t.name}</span>
                    <span class="provider-balance"><i class="fa fa-wallet"></i> Ø±ØµÙŠØ¯: ${l} Ø¬.Ù…</span>
                </div>
                <i class="fa fa-university provider-icon-bg"></i>
                <i class="fa fa-chevron-left" style="z-index:2; font-size: 14px; opacity:0.8"></i>
            `,a.onclick=()=>confirmProviderSelection(e,t.name),n.appendChild(a)})}catch(d){n.innerHTML='<div class="alert alert-danger mx-3">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª</div>'}}}function confirmProviderSelection(e,t){let a=serviceMap[e];if(!a)return;closeProviderModal();let n=document.querySelector(`.op-card[onclick*="${e}"]`);if(a.needsWallet){selectedProvider=t;let i=document.getElementById("type");i&&(i.value=a.buildTitle(t)),document.querySelectorAll(".op-card").forEach(e=>e.classList.remove("active","active-op")),n&&n.classList.add("active","active-op"),_toggleOpFields(a.buildTitle(t));let l=document.getElementById("wallet");l&&(l.disabled=!1,l.style.backgroundColor="",l.style.cursor="default",l.selectedIndex=0);let o=document.getElementById("pinnedWallets");o&&(o.style.outline="2px solid var(--primary-blue)",o.style.borderRadius="14px",o.style.transition="outline 0.3s",setTimeout(()=>{o.style.outline="none"},2500),o.scrollIntoView({behavior:"smooth",block:"nearest"})),showToast("\uD83D\uDCCC Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù…Ù† Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø«Ø¨ØªØ©",!0),"function"==typeof updateLimitDisplay&&updateLimitDisplay()}else setOp(a.buildTitle(t),t,n)}function closeProviderModal(){let e=document.getElementById("providerModal");e&&(e.style.display="none")}async function renderPinnedWallets(){let e=document.getElementById("pinnedWallets");if(e&&!isRenderingPins){isRenderingPins=!0;try{let t=window.currentUserData,a=_supa().from("accounts").select("id, name, balance, is_pinned, tag, color, daily_out_limit, daily_in_limit, monthly_limit, daily_out_usage, daily_in_usage, monthly_usage_out").eq("is_pinned",!0).order("name");"function"==typeof applyBranchFilter&&(a=applyBranchFilter(a,t));let{data:n,error:i}=await a;if(e.innerHTML="",i||!n||!n.length){e.innerHTML='<span class="text-muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙØ¸ Ù…Ø«Ø¨ØªØ©.</span>';return}document.body.classList.contains("light-mode"),n.forEach(function(t){let a=document.createElement("div"),n=Number(t.balance||0),i=Number(t.daily_out_limit||0),l=Number(t.daily_in_limit||0),o=Number(t.monthly_limit||0),s=Number(t.daily_out_usage||0),r=Number(t.daily_in_usage||0),d=Number(t.monthly_usage_out||0),c=Math.max(0,o>0?Math.min(i-s,o-d):i-s),u=Math.max(0,l-r),f=t.color||"#0ea5e9";a.style.cssText=`
                display:inline-flex;
                flex-direction:column;
                gap:6px;
                background:var(--pin-card-bg);
                color:var(--pin-text-main);
                border:1px solid var(--pin-card-border);
                border-radius:14px;
                padding:10px 14px;
                cursor:pointer;
                min-width:140px;
                direction:rtl;
                user-select:none;
                box-shadow:var(--pin-card-shadow);
                transition: border-color 0.2s, box-shadow 0.2s;
            `;var p=`
                <div style="display:flex; justify-content:space-between;">
                    <div style="display:flex; gap:6px; align-items:center;">
                        <i class="fa-solid fa-bolt" style="color:${f}; font-size:11px;"></i>
                        <span style="font-size:12px; font-weight:800; color:var(--pin-text-main);">${t.name}</span>
                    </div>
                    ${t.tag&&t.tag.trim()?`<span style="font-size:9px; background:${f}; color:#fff; padding:1px 7px; border-radius:20px; font-weight:700;">${t.tag}</span>`:""}
                </div>`,m=`
                <div style="border-top:1px dashed var(--pin-divider); padding-top:6px;">
                    <span style="font-size:9px; color:var(--pin-text-muted);">Ø±ØµÙŠØ¯</span>
                    <span style="font-size:14px; font-weight:800; color:${n<300?"#ef4444":n<1e3?"#f59e0b":"#10b981"}; margin-right:4px;">${n.toLocaleString()}</span>
                    <span style="font-size:9px; color:var(--pin-text-muted);">Ø¬.Ù…</span>
                </div>`,b=`
                <div style="display:flex; gap:6px;">
                    <div style="flex:1; text-align:center; background:var(--pin-in-bg); border-radius:8px; padding:4px;">
                        <div style="font-size:8px; color:var(--pin-text-muted);">Ø¯Ø®ÙˆÙ„</div>
                        <div style="font-weight:700; color:${u<500?"#ef4444":u<2e3?"#f59e0b":"#10b981"};">${u.toLocaleString()}</div>
                    </div>
                    <div style="flex:1; text-align:center; background:var(--pin-out-bg); border-radius:8px; padding:4px;">
                        <div style="font-size:8px; color:var(--pin-text-muted);">Ø®Ø±ÙˆØ¬</div>
                        <div style="font-weight:700; color:${c<500?"#ef4444":c<2e3?"#f59e0b":"#10b981"};">${c.toLocaleString()}</div>
                    </div>
                </div>`;a.innerHTML=p+m+b,a.onmouseenter=function(){a.style.borderColor=f,a.style.boxShadow="0 0 0 2px "+f+"33"},a.onmouseleave=function(){a.classList.contains("active")||(a.style.borderColor="var(--border-color, #e2e8f0)",a.style.boxShadow="var(--shadow-sm, 0 1px 3px rgba(0,0,0,0.05))")},a.onclick=function(){document.querySelectorAll("#pinnedWallets > div").forEach(function(e){e.classList.remove("active"),e.style.borderColor="var(--border-color, #e2e8f0)",e.style.boxShadow="var(--shadow-sm, 0 1px 3px rgba(0,0,0,0.05))"}),a.classList.add("active"),a.style.borderColor=f,a.style.boxShadow="0 0 0 3px "+f+"44",selectWalletFast(t.id,t.name,a)},e.appendChild(a)})}catch(l){e&&(e.innerHTML='<span class="text-muted small">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶</span>')}finally{isRenderingPins=!1}}}function selectWalletFast(e,t,a){let n=document.getElementById("wallet");if(n){for(let i=0;i<n.options.length;i++)if(n.options[i].value==e||_norm(n.options[i].text).includes(_norm(t))){n.selectedIndex=i;break}document.querySelectorAll(".pin-btn").forEach(e=>e.classList.remove("active")),a&&a.classList.add("active"),"function"==typeof updateLimitDisplay&&updateLimitDisplay(),n.dispatchEvent(new Event("change"))}}async function loadWalletsToSelect(e){let t=document.getElementById("wallet");if(!t)return;t.innerHTML='<option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';let a=window.currentUserData,n=_supa().from("accounts").select("id, name, balance, daily_out_limit").order("name");"function"==typeof applyBranchFilter&&(n=applyBranchFilter(n,a));let{data:i,error:l}=await n;if(l||!i){t.innerHTML='<option value="">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>';return}t.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨...</option>',i.forEach(a=>{let n=Number(a.daily_out_limit)||0,i=n>1e7,l=a.name.includes("Ø§Ù„Ø®Ø²Ù†Ø©");if("SAFE"===e&&!l||"WALLET"===e&&(l||i)||"COMPANY"===e&&!i)return;let o=Number(a.balance)||0;t.innerHTML+=`<option value="${a.id}"
            data-lo="${a.daily_out_limit||0}"
            data-li="${a.daily_in_limit||0}"
            data-lm="${a.monthly_limit||0}">
            ${a.name} (${o.toLocaleString()} Ø¬.Ù…)
        </option>`})}function runTransaction(){try{let e=e=>document.getElementById(e),t=e("type"),a=e("amount"),n=e("wallet"),i=e("comm"),l=e("commDestination"),o=e("client"),s=e("note"),r=e("deductCommFromAmount");if(!t?.value?.trim())return showToast("âš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ù† Ø§Ù„ÙƒØ±ÙˆØª Ø£ÙˆÙ„Ø§Ù‹",!1);if(!a?.value||0>=Number(a.value))return showToast("âš ï¸ Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­",!1);if(!n?.value)return showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø£Ùˆ Ø§Ù„Ø®Ø²Ù†Ø©",!1);let d=t.value,c=a.value.replace(/,/g,""),u=n.value,f=(n.options[n.selectedIndex]?.text||"").replace(/\s*\(.*\)/,"").trim(),p=(i?.value||"0").replace(/,/g,""),m=l?.value||"CASH",b=o?.value||"",y=s?.value||"",g=r?.checked||!1,$=selectedProvider||f||"Ø§Ù„Ø®Ø²Ù†Ø©";if(/Ø¯ÙŠÙ†|Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©|Ø³Ø¯Ø§Ø¯/.test(d)&&!b)return showToast("âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªØªØ·Ù„Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„",!1);let v=`
            <div style="background:rgba(255,255,255,0.05);border-radius:18px;padding:15px;margin-bottom:15px;border:1px solid rgba(255,255,255,0.1);">
                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                    <span style="color:var(--text-muted);font-size:13px;">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</span>
                    <span style="color:var(--text-main);font-weight:800;">${d}</span>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                    <span style="color:var(--text-muted);font-size:13px;">Ø§Ù„Ù…Ø¨Ù„Øº:</span>
                    <span style="color:var(--text-main);font-weight:800;font-size:18px;">${Number(c).toLocaleString()} Ø¬.Ù…</span>
                </div>
                ${Number(p)>0?`
                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                    <span style="color:var(--text-muted);font-size:13px;">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©:</span>
                    <span style="color:#f59e0b;font-weight:bold;">${Number(p).toLocaleString()} â† ${"CASH"===m?"\uD83D\uDCB0 Ø§Ù„Ø®Ø²Ù†Ø©":"\uD83D\uDCF1 Ø§Ù„Ù…Ø­ÙØ¸Ø©"}</span>
                </div>`:""}
                <div style="display:flex;justify-content:space-between;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.2);">
                    <span style="color:var(--text-muted);font-size:13px;">Ø§Ù„Ø¬Ù‡Ø©:</span>
                    <span style="color:#ffca28;font-weight:bold;">${$}</span>
                </div>
            </div>`;globalPendingData={walletId:u,walletName:f,type:d,provider:$,amount:c,comm:p,clientId:b,note:y,commDest:m,deductComm:g},showCustomConfirmModal(v+_buildFlowCard(d,$,f),_getOpColor(d))}catch(x){alert("Ø®Ø·Ø£: "+x.message)}}function _getOpColor(e){return/Ø³Ø¯Ø§Ø¯|ÙˆØ§Ø±Ø¯|Ø³Ø­Ø¨ Ù…Ù† Ù…Ø­ÙØ¸Ø©/.test(e)?"#10b981":/Ù…ØµØ±ÙˆÙ|Ø³Ø­Ø¨|Ø¥ÙŠØ¯Ø§Ø¹/.test(e)?"#ef4444":"#3b82f6"}function _buildFlowCard(e,t,a){let n=(e,t,a,n,i,l)=>`
        <div style="background:rgba(255,255,255,0.02);padding:15px;border-radius:18px;border:1px solid rgba(255,255,255,0.05);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <div style="text-align:center;width:70px;">
                    <div style="width:45px;height:45px;background:rgba(255,255,255,0.1);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 5px;">
                        <i class="fas ${t}" style="color:var(--text-main)"></i></div>
                    <span style="font-size:10px;color:var(--text-muted);font-weight:bold;">${e}</span>
                </div>
                <i class="fas fa-long-arrow-alt-left fa-2x" style="color:${i};opacity:0.8;flex:1;text-align:center;"></i>
                <div style="text-align:center;width:70px;">
                    <div style="width:45px;height:45px;background:${i};border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 5px;">
                        <i class="fas ${n}" style="color:#fff"></i></div>
                    <span style="font-size:10px;color:var(--text-muted);font-weight:bold;">${a}</span>
                </div>
            </div>
            <p style="margin:0;font-size:13px;color:var(--text-main);direction:rtl;line-height:1.5;">${l}</p>
        </div>`;return/Ø³Ø­Ø¨ Ù…Ù† Ø¹Ù…ÙŠÙ„|Ø³Ø­Ø¨ ÙÙŠØ²Ø§/.test(e)?n("Ø§Ù„Ø¹Ù…ÙŠÙ„","fa-user",t,"fa-server","#10b981",`ğŸ“¥ Ø±ØµÙŠØ¯ ${t} Ù‡ÙŠØ²ÙŠØ¯.<br>ğŸ“¤ ÙƒØ§Ø´ Ø§Ù„Ø®Ø²Ù†Ø© Ù‡ÙŠÙ‚Ù„.`):e.includes("Ø¯ÙØ¹ ÙØ§ØªÙˆØ±Ø©")?n("Ø§Ù„Ø¹Ù…ÙŠÙ„","fa-money-bill",t,"fa-server","#ef4444",`ğŸ“¥ ÙƒØ§Ø´ Ø§Ù„Ø®Ø²Ù†Ø© Ù‡ÙŠØ²ÙŠØ¯.<br>ğŸ“¤ Ø±ØµÙŠØ¯ ${t} Ù‡ÙŠÙ‚Ù„.`):/Ø³Ø­Ø¨ ÙƒØ§Ø´|ØªØ²ÙˆÙŠØ¯/.test(e)?n("Ø§Ù„Ù…Ø­ÙØ¸Ø©","fa-wallet",t,"fa-server","#3b82f6",`ğŸ“¥ Ø±ØµÙŠØ¯ ${t} Ù‡ÙŠØ²ÙŠØ¯.<br>â„¹ï¸ Ø¹Ù…Ù„ÙŠØ© ØªÙ†Ø¸ÙŠÙ…ÙŠØ©.`):/Ø¥ÙŠØ¯Ø§Ø¹|Ø´Ø­Ù†|ØªØ­ÙˆÙŠÙ„/.test(e)?n(a,"fa-wallet","Ø§Ù„Ø¹Ù…ÙŠÙ„","fa-user","#ef4444","ï¿½Ù‰ ÙƒØ§Ø´ Ø§Ù„Ø®Ø²Ù†Ø© Ø²Ø§Ø¯.<br>\uD83D\uDCE4 Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù‚Ù„."):e.includes("Ø³Ø­Ø¨ Ù…Ù† Ù…Ø­ÙØ¸Ø©")?n("Ø§Ù„Ø¹Ù…ÙŠÙ„","fa-user",a,"fa-wallet","#10b981","\uD83D\uDCE5 Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù‡ÙŠØ²ÙŠØ¯.<br>\uD83D\uDCE4 ÙƒØ§Ø´ Ø§Ù„Ø®Ø²Ù†Ø© Ù‡ÙŠÙ‚Ù„."):e.includes("Ø³Ø¯Ø§Ø¯")?`<div style="padding:15px;text-align:center;color:#10b981;font-weight:bold;">âœ… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ³Ø¯Ø¯ Ø¯ÙŠÙ†</div>`:/Ø¯ÙŠÙ†|Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©/.test(e)?`<div style="padding:15px;text-align:center;color:#ef4444;font-weight:bold;">âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯</div>`:e.includes("Ù…ØµØ±ÙˆÙ")?`<div style="padding:15px;text-align:center;color:#f59e0b;font-weight:bold;">ğŸ’¸ Ù…ØµØ±ÙˆÙ Ù…Ù† Ø§Ù„Ø®Ø²Ù†Ø©</div>`:`<p style="text-align:center;padding:10px;">ØªØ£ÙƒÙŠØ¯: <b>${e}</b></p>`}function showCustomConfirmModal(e,t){t=t||"#3b82f6",document.getElementById("customConfirmModal")?.remove(),document.body.insertAdjacentHTML("beforeend",`
        <div id="customConfirmModal"
            style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,0.85);
                   backdrop-filter:blur(4px);display:flex;justify-content:center;align-items:center;
                   z-index:10000;padding:20px;font-family:'Cairo',sans-serif;">
            <div style="background:var(--bg-card,#1e293b);width:100%;max-width:390px;border-radius:24px;
                        box-shadow:0 20px 50px rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1);overflow:hidden;">
                <div style="background:${t};padding:15px;text-align:center;color:#fff;">
                    <i class="fas fa-file-invoice-dollar fa-2x mb-2"></i>
                    <h6 style="margin:0;font-weight:800;font-size:16px;">Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h6>
                </div>
                <div style="padding:25px 20px;">${e}</div>
                <div style="padding:0 20px 25px;display:flex;gap:12px;">
                    <button onclick="finalExecuteStep(this)"
                        style="flex:2;padding:14px;border:none;border-radius:15px;background:${t};
                               color:#fff;font-weight:bold;font-size:15px;cursor:pointer;">
                        âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                    </button>
                    <button onclick="document.getElementById('customConfirmModal').remove()"
                        style="flex:1;padding:14px;border:1px solid #475569;border-radius:15px;
                               background:rgba(255,255,255,0.05);color:#94a3b8;cursor:pointer;">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        </div>`)}async function finalExecuteStep(e){if(globalPendingData){e.disabled=!0,e.innerHTML='<i class="fa fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';try{let t=await getSession(),a=t?.user?.user_metadata?.name||t?.user?.email||"Unknown",n=new Date,{walletId:i,walletName:l,type:o,provider:s,amount:r,comm:d,clientId:c,note:u,commDest:f,deductComm:p}=globalPendingData,{data:m}=await _supa().from("accounts").select("*"),b=window.currentUserData?.branch_id||null,y=m?.find(e=>e.name.includes("Ø§Ù„Ø®Ø²Ù†Ø©")&&(!b||e.branch_id===b)),g=m?.find(e=>e.id==i&&!e.name.includes("Ø§Ù„Ø®Ø²Ù†Ø©")),$=m?.find(e=>_norm(e.name).includes(_norm(s))&&Number(e.daily_out_limit)>1e7&&(!b||e.branch_id===b));if(!y)throw Error("Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø²Ù†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹");let v=Number(r),x=Number(d)||0,h=[],w=0,_=(e,t)=>{e&&h.push({id:e.id,changes:t})},L=(e,t,a)=>{if(e&&!(Number(e.daily_out_limit)>1e7)){if("OUT"===a){let n=Math.max(0,Number(e.daily_out_limit)-Number(e.daily_out_usage)),i=Math.max(0,Number(e.monthly_limit)-Number(e.monthly_usage_out)),l=Number(e.monthly_limit)>0?Math.min(n,i):n;if(t>l)throw Error("âŒ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù„ÙŠÙ…ÙŠØª â€” Ø§Ù„Ù…ØªØ§Ø­ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„: "+l.toLocaleString()+" Ø¬.Ù…")}else if("IN"===a){let o=Math.max(0,Number(e.daily_in_limit)-Number(e.daily_in_usage));if(Number(e.daily_in_limit)>0&&t>o)throw Error("âŒ ØªØ¬Ø§ÙˆØ² Ù„ÙŠÙ…ÙŠØª Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ â€” Ø§Ù„Ù…ØªØ§Ø­: "+o.toLocaleString()+" Ø¬.Ù…")}}};if(/Ø¥ÙŠØ¯Ø§Ø¹|Ø´Ø­Ù†|ØªØ­ÙˆÙŠÙ„|Ø¨Ø§Ù‚Ø©|ØªØ¬Ø¯ÙŠØ¯|Ø±ØµÙŠØ¯|Ø¯ÙØ¹ ÙÙŠØ²Ø§/.test(o)&&!o.includes("Ø³Ø­Ø¨ Ù…Ù†")?L(g,v,"OUT"):o.includes("Ø³Ø­Ø¨ Ù…Ù† Ù…Ø­ÙØ¸Ø©")?L(g,v,"IN"):o.includes("Ø³Ø­Ø¨ ÙƒØ§Ø´")?L(g,v,"OUT"):/Ø¯ÙŠÙ†|Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©/.test(o)&&L(g,v,/Ø³Ø­Ø¨|ØµØ§Ø¯Ø±/.test(o)?"OUT":"IN"),o.includes("Ø³Ø­Ø¨ ÙƒØ§Ø´")&&/Ù…ÙƒØ³Ø¨|ÙÙˆØ±ÙŠ/.test(s)){if(!g)throw Error("âŒ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©");if(!$)throw Error(`âŒ Ø­Ø³Ø§Ø¨ ${s} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);if(+g.balance<v-x)throw Error(`âŒ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ø§ ÙŠÙƒÙÙŠ â€” Ø§Ù„Ù…ØªØ§Ø­: ${Number(g.balance).toLocaleString()} Ø¬.Ù…`);_($,{balance:+$.balance+v}),_(g,{balance:+g.balance-v+x,profit:+g.profit+x,daily_out_usage:+g.daily_out_usage+v,monthly_usage_out:+g.monthly_usage_out+v}),w=+g.balance-v+x}else if(o.includes("Ø³Ø­Ø¨ ÙƒØ§Ø´")&&$){if(!g)throw Error("âŒ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©");if(+g.balance<v)throw Error(`âŒ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ø§ ÙŠÙƒÙÙŠ â€” Ø§Ù„Ù…ØªØ§Ø­: ${Number(g.balance).toLocaleString()} Ø¬.Ù…`);_(g,{balance:+g.balance-v,daily_out_usage:+g.daily_out_usage+v,monthly_usage_out:+g.monthly_usage_out+v}),"CASH"===f?(_($,{balance:+$.balance+v}),_(y,{balance:+y.balance+x,profit:+y.profit+x})):_($,{balance:+$.balance+v+x,profit:+$.profit+x}),w=+g.balance-v}else if(/Ø³Ø­Ø¨ Ù…Ù† Ø¹Ù…ÙŠÙ„|Ø³Ø­Ø¨ ÙÙŠØ²Ø§/.test(o)){if(!$)throw Error(`Ø­Ø³Ø§Ø¨ ${s} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);if(+y.balance<v)throw Error("Ø±ØµÙŠØ¯ Ø§Ù„Ø®Ø²Ù†Ø© Ù„Ø§ ÙŠÙƒÙÙŠ");"CASH"===f?(_(y,{balance:+y.balance-v+x,profit:+y.profit+x}),_($,{balance:+$.balance+v})):(_(y,{balance:+y.balance-v}),_($,{balance:+$.balance+v+x,profit:+$.profit+x})),w=+$.balance+v}else if(o.includes("Ø¯ÙØ¹ ÙØ§ØªÙˆØ±Ø©")){if(!$)throw Error(`âŒ Ø­Ø³Ø§Ø¨ ${s} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);if(+$.balance<v)throw Error(`âŒ Ø±ØµÙŠØ¯ ${s} Ù„Ø§ ÙŠÙƒÙÙŠ â€” Ø§Ù„Ù…ØªØ§Ø­: ${Number($.balance).toLocaleString()} Ø¬.Ù…`);_($,{balance:+$.balance-v}),_(y,{balance:+y.balance+v+x,profit:+y.profit+x}),w=+$.balance-v}else if(o.includes("Ù…ØµØ±ÙˆÙ")){if(+y.balance<v)throw Error("Ø±ØµÙŠØ¯ Ø§Ù„Ø®Ø²Ù†Ø© Ù„Ø§ ÙŠÙƒÙÙŠ");_(y,{balance:+y.balance-v}),w=+y.balance-v}else if(/Ø¥ÙŠØ¯Ø§Ø¹|Ø´Ø­Ù†|ØªØ­ÙˆÙŠÙ„|Ø¨Ø§Ù‚Ø©|ØªØ¬Ø¯ÙŠØ¯|Ø±ØµÙŠØ¯|Ø¯ÙØ¹ ÙÙŠØ²Ø§/.test(o)&&!o.includes("Ø³Ø­Ø¨ Ù…Ù†")){if(!g)throw Error("ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©");let S=+g.balance-v-1+("WALLET"===f?x:0);if(S<0)throw Error(`Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ â€” Ø§Ù„Ù…ØªØ§Ø­ ${Number(g.balance).toLocaleString()}`);_(g,{balance:S,daily_out_usage:+g.daily_out_usage+v,monthly_usage_out:+g.monthly_usage_out+v,..."WALLET"===f?{profit:+g.profit+x}:{}}),_(y,{balance:+y.balance+v,..."CASH"===f?{profit:+y.profit+x}:{}}),w=S}else if(o.includes("Ø³Ø­Ø¨ Ù…Ù† Ù…Ø­ÙØ¸Ø©")){if(!g)throw Error("Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©");let T=p?v:v-x;if(+y.balance<T)throw Error("Ø±ØµÙŠØ¯ Ø§Ù„Ø®Ø²Ù†Ø© Ù„Ø§ ÙŠÙƒÙÙŠ");_(g,{balance:+g.balance+v,daily_in_usage:+g.daily_in_usage+v,monthly_usage_in:+g.monthly_usage_in+v,..."WALLET"===f&&x>0?{profit:+g.profit+x}:{}}),_(y,{balance:+y.balance-T,..."CASH"===f&&x>0?{profit:+y.profit+x}:{}}),w=+g.balance+v}else if(/Ø¯ÙŠÙ†|Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©/.test(o)){if(!c)throw Error("âŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙŠÙˆÙ†");let E=/Ø³Ø­Ø¨|ØµØ§Ø¯Ø±/.test(o),C=g||y;if(E){if(+C.balance<v)throw Error("âŒ Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ");g?(_(g,{balance:+g.balance-v,daily_out_usage:+g.daily_out_usage+v,monthly_usage_out:+g.monthly_usage_out+v}),x>0&&_(y,{balance:+y.balance+x,profit:+y.profit+x})):_(y,{balance:+y.balance-v+x,...x>0?{profit:+y.profit+x}:{}}),w=+C.balance-v,await _updateClientBalance(c,v,"OUT")}else g?_(g,{balance:+g.balance+v+x,daily_in_usage:+g.daily_in_usage+v,monthly_usage_in:(+g.monthly_usage_in||0)+v,...x>0?{profit:+g.profit+x}:{}}):_(y,{balance:+y.balance+v+x,...x>0?{profit:+y.profit+x}:{}}),w=+C.balance+v+x,await _updateClientBalance(c,v,"IN")}else throw Error(`Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© '${o}' ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù`);for(let I of h){let{error:k}=await _supa().from("accounts").update(I.changes).eq("id",I.id);if(k)throw k}let{error:B}=await _supa().from("transactions").insert([{date:n.toLocaleDateString("en-GB"),time:n.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}),type:o,amount:v,commission:x,wallet_name:l,provider:s,balance_after:w,notes:u||"",added_by:a,branch_id:window.currentUserData?.branch_id||null}]);if(B)throw B;document.getElementById("customConfirmModal")?.remove(),showToast("âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­",!0),resetSystemInterface(),"function"==typeof loadDash&&loadDash(),"function"==typeof loadTransactionLogs&&loadTransactionLogs(),renderPinnedWallets(),"function"==typeof refreshAllWalletViews&&refreshAllWalletViews()}catch(M){showToast("âŒ "+M.message,!1),e.disabled=!1,e.innerHTML="âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"}finally{globalPendingData=null}}}async function _updateClientBalance(e,t,a){if(!e)return;let{data:n,error:i}=await _supa().from("clients").select("id, balance").eq("id",e).maybeSingle();if(!n||i)return;let l=Number(n.balance)||0,{error:o}=await _supa().from("clients").update({balance:"OUT"===a?l+t:Math.max(0,l-t)}).eq("id",n.id)}function resetSystemInterface(){["amount","note","type"].forEach(e=>{let t=document.getElementById(e);t&&(t.value="")});let e=document.getElementById("comm");e&&(e.value="0");let t=document.getElementById("commDestination");t&&(t.value="CASH",t.dispatchEvent(new Event("change"))),["wallet","client"].forEach(e=>{let t=document.getElementById(e);t&&(t.selectedIndex=0,t.disabled=!1,t.style.backgroundColor="",t.style.cursor="default")}),document.querySelectorAll(".op-card").forEach(e=>{e.classList.remove("active","active-op"),e.style.background="",e.style.borderColor=""}),document.querySelectorAll(".pin-btn").forEach(e=>e.classList.remove("active")),globalPendingData=null,selectedProvider="";let a=document.getElementById("clientBalanceStatus");a&&(a.innerHTML="");let n=document.getElementById("limitStatus");n&&(n.style.display="none"),"function"==typeof toggleClientField&&toggleClientField()}var resetTransactionForm=resetSystemInterface;function renderTransactionsTable(e){let t=document.getElementById("timelineContainer");if(!t)return;if(!e||!e.length){t.innerHTML='<tr><td colspan="8" class="text-center py-4 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';return}let a=1;t.innerHTML=e.map(e=>{let t=/Ø³Ø­Ø¨|ØµØ§Ø¯Ø±|Ù…ØµØ±ÙˆÙ|ÙØ§ØªÙˆØ±Ø©/.test(e.type||""),n=new Date(e.created_at||new Date),i=new Date-n<1e4;return`
            <tr class="${i?"new-row-flash":""}">
                <td class="align-middle">${a++}</td>
                
                <td class="align-middle english-num small text-nowrap">
                    <div class="fw-bold">${e.date||"-"}</div>
                    <div class="text-muted" style="font-size: 10px;">${e.time||""}</div>
                </td>
                
                <td class="align-middle text-center ${t?"text-danger":"text-success"} fw-bold">
                    <div><i class="fa ${t?"fa-arrow-up":"fa-arrow-down"} me-1" style="font-size:10px;"></i>${esc(e.type)||"-"}</div>
                    ${e.wallet_name||e.provider?`<div class="d-flex align-items-center justify-content-center gap-1 mt-1 flex-wrap">
                        ${e.wallet_name?`<span class="badge bg-light text-dark border fw-normal" style="font-size:9px;"><i class="fa fa-wallet me-1 text-primary" style="font-size:8px;"></i>${esc(e.wallet_name)}</span>`:""}
                        ${e.wallet_name&&e.provider?'<i class="fa fa-arrow-left text-muted" style="font-size:8px;"></i>':""}
                        ${e.provider?`<span class="badge bg-light text-dark border fw-normal" style="font-size:9px;"><i class="fa fa-building me-1 text-warning" style="font-size:8px;"></i>${esc(e.provider)}</span>`:""}
                    </div>`:""}
                </td>
                
                <td class="align-middle english-num fw-bold">
                    <div>${Number(e.amount||0).toLocaleString()}</div>
                    ${e.commission?`<small class="text-warning fw-normal" style="font-size: 10px;">Ø¹Ù…ÙˆÙ„Ø©: ${Number(e.commission).toLocaleString()}</small>`:""}
                </td>
                
                <td class="align-middle english-num text-primary fw-bold">
                    ${Number(e.balance_after||0).toLocaleString()}
                </td>
                
                <td class="align-middle small text-muted" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">
                    ${esc(e.notes)||"-"}
                </td>
                
                <td class="align-middle">
                    <span class="badge bg-light text-dark border fw-normal">
                        <i class="fa fa-user-circle me-1 text-secondary"></i>${esc(e.added_by)||"-"}
                    </span>
                </td>
                
                <td class="align-middle">
                    <div class="d-flex justify-content-center gap-1">
                        <button class="btn btn-sm btn-outline-secondary border-0" onclick="showDetails(${e.id})" title="Ø¹Ø±Ø¶">
                            <i class="fa fa-eye"></i>
                        </button>
                        
                        <button class="btn btn-sm btn-outline-danger admin-only border-0" onclick="rollbackTx(${e.id})" title="ØªØ±Ø§Ø¬Ø¹">
                            <i class="fa fa-undo"></i>
                        </button>
                    </div>
                </td>
            </tr>`}).join("")}function formatDate(e){if(!e)return"-";let t=new Date(e),a=t.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}),n=t.getDate(),i=t.getMonth()+1;return`${n}/${i} | ${a}`}function executeAdvancedSearch(){clearTimeout(searchTimeout),searchTimeout=setTimeout(async()=>{let e={text:(document.getElementById("advSearchText")?.value||"").trim().toLowerCase(),type:document.getElementById("advSearchType")?.value||"",dateFrom:document.getElementById("advDateFrom")?.value||"",dateTo:document.getElementById("advDateTo")?.value||""},t=document.getElementById("timelineContainer");t&&(t.innerHTML='<tr><td colspan="8" class="py-4 text-center"><i class="fa fa-sync fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</td></tr>');let a=await getTransactionLogs(e);if(!a)return;let n=a.filter(t=>(t.wallet_name?.toLowerCase()||"").includes(e.text)||(t.notes?.toLowerCase()||"").includes(e.text)||String(t.amount).includes(e.text));renderTransactionsTable(n);let i=document.getElementById("rowsCountDisplay");i&&(i.innerText=`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${n.length} Ø¹Ù…Ù„ÙŠØ©`)},500)}async function rollbackTx(e){if(!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ"))return;let{data:t}=await _supa().from("transactions").select("*").eq("id",e).maybeSingle();if(!t)return showToast("âŒ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©",!1);let{data:a}=await _supa().from("accounts").select("*"),n=Number(t.amount),i=Number(t.commission)||0,l=[],o=e=>Math.max(0,e),s=a?.find(e=>e.name.includes("Ø§Ù„Ø®Ø²Ù†Ø©")),r=a?.find(e=>e.name===t.wallet_name&&!e.name.includes("Ø§Ù„Ø®Ø²Ù†Ø©")&&1e7>=Number(e.daily_out_limit)),d=a?.find(e=>_norm(e.name).includes(_norm(t.provider))&&Number(e.daily_out_limit)>1e7),c=(e,t)=>{e&&l.push({id:e.id,changes:t})};if(t.type.includes("Ø¯ÙØ¹ ÙØ§ØªÙˆØ±Ø©")){if(!d)return showToast(`âŒ Ø­Ø³Ø§Ø¨ ${t.provider} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`,!1);c(d,{balance:+d.balance+n}),c(s,{balance:+s.balance-n-i,profit:o(+s.profit-i)})}else if(/Ø³Ø­Ø¨ Ù…Ù† Ø¹Ù…ÙŠÙ„|Ø³Ø­Ø¨ ÙÙŠØ²Ø§/.test(t.type))c(d,{balance:+d?.balance-n}),c(s,{balance:+s?.balance+n-i,profit:o(+s?.profit-i)});else if(/Ø¥ÙŠØ¯Ø§Ø¹|Ø´Ø­Ù†|ØªØ­ÙˆÙŠÙ„|Ø¨Ø§Ù‚Ø©|ØªØ¬Ø¯ÙŠØ¯|Ø±ØµÙŠØ¯/.test(t.type)&&r)c(r,{balance:+r.balance+n+1,daily_out_usage:o(+r.daily_out_usage-n),monthly_usage_out:o(+r.monthly_usage_out-n)}),c(s,{balance:+s?.balance-n,profit:o(+s?.profit-i)});else if(t.type.includes("Ø³Ø­Ø¨ Ù…Ù† Ù…Ø­ÙØ¸Ø©")&&r)c(r,{balance:+r.balance-n,daily_in_usage:o(+r.daily_in_usage-n),monthly_usage_in:o(+r.monthly_usage_in-n)}),c(s,{balance:+s?.balance+n-i,profit:o(+s?.profit-i)});else if(t.type.includes("Ø³Ø­Ø¨ ÙƒØ§Ø´")&&r)c(r,{balance:+r.balance+n,profit:o(+r.profit-i),daily_out_usage:o(+r.daily_out_usage-n),monthly_usage_out:o(+r.monthly_usage_out-n)}),c(d,{balance:+d?.balance-n}),i>0&&c(s,{balance:+s?.balance-i,profit:o(+s?.profit-i)});else if(t.type.includes("Ù…ØµØ±ÙˆÙ"))c(s,{balance:+s?.balance+n});else if(/Ø¯ÙŠÙ†|Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©/.test(t.type)){let u=/Ø³Ø­Ø¨|ØµØ§Ø¯Ø±/.test(t.type);u?(r?(c(r,{balance:+r.balance+n,daily_out_usage:o(+r.daily_out_usage-n),monthly_usage_out:o(+r.monthly_usage_out-n)}),i>0&&c(s,{balance:+s?.balance-i,profit:o(+s?.profit-i)})):c(s,{balance:+s?.balance+n-i,profit:o(+s?.profit-i)}),t.client_id&&await _updateClientBalance(t.client_id,n,"IN")):(r?c(r,{balance:+r.balance-n-i,daily_in_usage:o(+r.daily_in_usage-n),monthly_usage_in:o((+r.monthly_usage_in||0)-n),profit:o(+r.profit-i)}):c(s,{balance:+s?.balance-n-i,profit:o(+s?.profit-i)}),t.client_id&&await _updateClientBalance(t.client_id,n,"OUT"))}for(let f of l)await _supa().from("accounts").update(f.changes).eq("id",f.id);await _supa().from("transactions").delete().eq("id",e);let p=await getSession(),m=p?.user?.id,{data:b}=await _supa().from("users").select("name").eq("id",m).single(),y=b?.name||p?.user?.email;await _supa().from("admin_logs").insert([{action:"ROLLBACK",details:`ØªØ±Ø§Ø¬Ø¹: ${t.type} Ø¨Ù…Ø¨Ù„Øº ${n}`,created_by:y,branch_id:window.currentUserData?.branch_id||null}]),showToast("âœ… ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¨Ù†Ø¬Ø§Ø­",!0),executeAdvancedSearch(),renderPinnedWallets(),"function"==typeof loadDash&&loadDash()}function applySecurityUI(e){document.querySelectorAll(".admin-only").forEach(t=>{"ADMIN"===e?t.style.setProperty("display","TD"===t.tagName||"TH"===t.tagName?"table-cell":"block","important"):t.style.display="none"})}async function calculateStats(){let{data:e}=await _supa().from("accounts").select("balance"),{data:t}=await _supa().from("transactions").select("commission").limit(1e3);return{totalBalance:(e||[]).reduce((e,t)=>e+Number(t.balance),0),totalProfit:(t||[]).reduce((e,t)=>e+Number(t.commission),0),totalTransactions:t?.length||0}}window.addEventListener("DOMContentLoaded",function(){"function"==typeof applyTheme&&applyTheme(),"function"==typeof checkUserRole&&checkUserRole(),"function"==typeof toggleClientField&&toggleClientField(),"function"==typeof renderWalletsCards&&renderWalletsCards(),"function"==typeof loadDash&&loadDash()});
